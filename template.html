<style>
    .swiper-container {
        width: 100%;
        height: 100%;
        border: 1px solid gray;
    }
    .swiper-slide {
        text-align: center;
        font-size: 18px;
        background: #fff;
        /* Center slide text vertically */
        display: -webkit-box;
        display: -ms-flexbox;
        display: -webkit-flex;
        display: flex;
        -webkit-box-pack: center;
        -ms-flex-pack: center;
        -webkit-justify-content: center;
        justify-content: center;
        -webkit-box-align: center;
        -ms-flex-align: center;
        -webkit-align-items: center;
        align-items: center;
    }
    .btn-group-answer-bottom {
        position:fixed;
        bottom:0; 
        height:auto; 
        z-index:99; 
        width:100%;
        background: white;
    }
    .btn-group-answer-bottom .left {
        border-right: 1px solid grey;
    }

    .btn-white {
        background: white;
        margin-top: 0;
    }

    #stage {
        display: none;
        border: 1px solid gray;
    }

    .close-icon {
        position:relative;
        background: rgba(0,0,0,0.5);
        color: white;
        z-index:999;
        padding-top: 4px;
        padding-bottom: 2px;
        border-radius: 5px;
        margin-top: 15px;
        margin-right: 15px;
    }

    .zoom-icon {
        margin-top:15px;
        margin-left:15px;
    }

    .step1,
    .step2 {
        display:none;
    }

</style>
<div class="row skeleton">
    <div class="col-xs-12 col-sm-9">
        <!-- Swiper -->
        <div id="stage">
            <div class="close-icon pull-right"><i class="fa fa-2x fa-fw fa-times-circle-o"></i></div>
        </div>
        <div class="swiper-container">
            <div class="zoom-icon pull-left"><i class="fa fa-2x fa-fw fa-search-plus"></i></div>
            <div class="swiper-wrapper">
            </div>
            <!-- Add Pagination -->
            <div class="swiper-pagination"></div>
        </div>
    </div>
</div>
<div class="row btn-group-answer-bottom">
    <div class="col-xs-6 left">
        <button type="button" class="btn btn-white btn-answer step1" value="yes">Yes</button>
        <button type="button" class="btn btn-white btn-answer step2" value="no">Yo no veo trigo</button>
    </div>
    <div class="col-xs-6 right">
        <button type="button" class="btn btn-white btn-answer step1" value="no">No</button>
        <button type="button" class="btn btn-white btn-answer step2" value="yes">Sí, ahí hay trigo o trazas</button>
    </div>
</div>

<script type="text/javascript">
(function() {
// Default language
var userLocale = "en";
// Translations
var messages = {"en": {
                        "i18n_working_task": "Task",
                      },
                "es": {
                        "i18n_working_task": "Tarea",
                      },
               };
// Update userLocale with server side information
$(document).ready(function(){
    userLocale = document.getElementById('PYBOSSA_USER_LOCALE').textContent.trim();
});

function i18n_translate() {
    var ids = Object.keys(messages[userLocale])
    for (i=0; i<ids.length; i++) {
        console.log("Translating: " + ids[i]);
        document.getElementById(ids[i]).innerHTML = messages[userLocale][ids[i]];
    }
}

pybossa.taskLoaded(function(task, deferred) {
    if ( !$.isEmptyObject(task) ) {
        // load image from flickr
        task.answer = { 'glutenfreeSeal': 'no',
                        'wheatIngredients': 'no',
                        'nimages': 0}
        if (task.info.images.length > 0) {
            var img = $('<img />');
            img.load(function() {
                // continue as soon as the image is loaded
                deferred.resolve(task);
            });
            img.attr('src', task.info.images[0]).css('height', 'auto');
            img.css('max-width', '100%');
            task.info.tmpImage = img;
            task.answer.nimages = task.info.images.length;
        }
        else {
            deferred.resolve(task);
        }
    }
    else {
        deferred.resolve(task);
    }
});


function saveAnswerAndClean(task, swiper, deferred) {
    $(".magnifik").magnifik('close');
    $(".step1").hide();
    $(".step2").hide();
    pybossa.saveTask(task.id, task.answer).done(function() {
        var deleteInstance = true;
        var cleanupStyles = false;
        swiper.destroy(deleteInstance, cleanupStyles);
        deferred.resolve();
    });

}

pybossa.presentTask(function(task, deferred) {
    if ( !$.isEmptyObject(task) ) {
        $(".swiper-wrapper").html("");
        //i18n_translate();
        //$('#photo-link').html('').append(task.info.image);
        //$("#photo-link").attr("href", task.info.link);

        var question1 = $("<h4/>");
        var question2 = $("<h4/>");
        question1.text('¿Ves el sello "Sin Gluten"?');
        question1.addClass('step1');
        question2.text('¿Trigo en los ingredientes?');
        question2.addClass('step2');
        $("#question").html("");
        $("#question").append(question1);
        $("#question").append(question2);

        $(".step1").show();
        $(".step2").hide();

        var w = document.documentElement.clientWidth;
        var h = document.documentElement.clientHeight;

        $("#stage").css("height", h);
        $("body").bind('magnifik:open', function(){
                console.log("show");
                $("#stage").show();
                $(".swiper-container").hide();
                });

        $("body").bind('magnifik:close', function(){
                console.log("hide");
                $("#stage").hide();
                $(".swiper-container").show();
                });


        $(".close-icon").bind('click', function(){
                $(".magnifik").magnifik('close');
                });



        for (i=0;i<task.info.images.length;i++) {
            var div = $("<div/>");
            div.addClass("swiper-slide");
            var img = $("<img/>");
            img.attr("src", task.info.images[i]);
            img.addClass("magnifik");
            div.append(img);
            $(".swiper-wrapper").append(div);
        }

        var swiper = new Swiper('.swiper-container', {
                pagination: '.swiper-pagination',
                paginationClickable: true
            });

        $('.magnifik').magnifik({seekImage: false, stage: $("#stage")});

        $(".zoom-icon").off('click').on('click', function(){
                $(".magnifik").magnifik('open');
                });

        $('.btn-answer.step1').off('click').on('click', function(evt) {
            var $btn = $(this);
            var answer = $btn.attr("value");
            if (typeof answer != 'undefined') {
            
                task.answer.glutenfreeSeal = answer
                console.log("Step 1 completed");
                console.log(task.answer);
                if (answer === 'yes') {
                   saveAnswerAndClean(task, swiper, deferred);
                }
                else {
                    $(".step1").hide();
                    $(".step2").show();
                }
            }
            else {
                pybossaNotify('Unexpected type of answer.', true, 'error');
            }
        });


        $('.btn-answer.step2').off('click').on('click', function(evt) {
            var $btn = $(this);
            var answer = $btn.attr("value");
            if (typeof answer != 'undefined') {
                task.answer.wheatIngredients = answer;
                console.log("Step 2 completed");
                console.log(task.answer);

                saveAnswerAndClean(task, swiper, deferred);
            }
            else {
                pybossaNotify('Unexpected type of answer.', true, 'error');
            }
        });
    }
    else {
        $(".skeleton").hide();
        pybossaNotify('You have contributed to all available tasks! Thanks!', true, 'info');
    }
});

pybossa.run('soytestproject1');
})();
</script>
