<style>
    .swiper-container {
        width: 100%;
        height: 100%;
        border: 1px solid #9ba9b0;
        margin-top: 0px;
    }
    @media(min-width: 768px) {
        .swiper-container {
            margin-top: 35px;
        }
    }
    .swiper-slide {
        text-align: center;
        font-size: 18px;
        background: #fff;
        /* Center slide text vertically */
        display: -webkit-box;
        display: -ms-flexbox;
        display: -webkit-flex;
        display: flex;
        -webkit-box-pack: center;
        -ms-flex-pack: center;
        -webkit-justify-content: center;
        justify-content: center;
        -webkit-box-align: center;
        -ms-flex-align: center;
        -webkit-align-items: center;
        align-items: center;
    }

    .swiper-pagination {
        position: relative;
        margin-top: 5px;
    }

    .swiper-pagination-bullet {
        margin: 2px;
        background: #9ba9b0;
    }
    .swiper-pagination-bullet-active {
        background: #546E7A;
    }
    .btn-group-answer-bottom {
        border-top: 1px solid #9ba9b0;
        position:fixed;
        bottom:0; 
        height:auto; 
        z-index:99; 
        width:100%;
        background: white;
        margin-right: 0px;
        margin-left: 0px;
    }
    .btn-group-answer-bottom .col-xs-6 {
        padding-left: 0;
        padding-right: 0;
    }

    .btn-group-answer-bottom .col-xs-6 button {
        padding-left: 0px;
        padding-right: 0px;
    }
    .btn-group-answer-bottom .left {
        border-right: 1px solid #9ba9b0;
    }

    .btn-white {
        background: white;
        margin-top: 0;
    }

    #stage {
        display: none;
        border: 1px solid #9ba9b0;
    }

    @media (min-width: 768px) {
        #stage {
            margin-top: 35px;
        }
    }

    .close-icon {
        position:relative;
        background: rgba(0,0,0,0.5);
        color: white;
        z-index:999;
        padding-top: 4px;
        padding-bottom: 2px;
        border-radius: 5px;
        margin-top: 15px;
        margin-right: 15px;
    }

    .step1,
    .step2 {
        display:none;
    }

    .zoom-info {
        margin-top: 10px;
        font-size: 13px;
    }

    .mobileHoverFix:hover,
    .mobileHoverFix.hover,
    .mobileHoverFix:focus,
    .mobileHoverFix.focus{
        color: #546e7b;
    }

    #question-md {
        margin-top:35px;
    }

    #question-md h4 {
        font-size: 22px;
    }

    .help-full{
        display: none;
        position: absolute;
        top: 0;
        background-color: #86B9D7;
        left: 0;
        height: 100%;
        width: 100%;
        z-index: 99999999999999999999999999999;
        color: white;
    }
    .help-full p {
        color: white;
    }

    .non-readable {
        width: 100%;
        position: fixed;
        bottom: 60px;
    }
    .non-readable a {
        font-size: 12px;
    }

</style>
<div class="container help-full help1">
    <div class="row">
        <div class="col-xs-12 col-md-offset-4 col-md-4 text-center">
            <h2>Sr. Alérgeno</h2>
            <img src="/static/img/sr-showing-gluten.svg" style="height:180px;">
            <h3>¿Sin Gluten?</h3>
            <p>Este símbolo, o uno parecido, es lo que estoy buscando. Te mostraré una imagen (o varias) y sólo tienes que decirme si lo ves, ¿ok?</p>
        </div>
        <div class="col-md-12" style="text-align:center;">
            <a id="help1" href="#" class="btn btn-tutorial"> 
                Entendido!</a>
        </div>
    </div>
</div>
<div class="container help-full help2">
    <div class="row">
        <div class="col-xs-12 col-md-offset-4 col-md-4 text-center">
            <h2>Sr. Alérgeno</h2>
            <img src="/static/img/sr-showing-gluten.svg" style="height:180px;">
            <h3>¿Hay trigo en los ingredientes?</h3>
            <p>Ahora vamos a comprobar las etiquetas. Dime si ves trigo en los ingredientes. ¡Las trazas tampoco nos gustan!</p>
        </div>
        <div class="col-md-12" style="text-align:center;">
            <a id="help2" href="#" class="btn btn-tutorial"> 
                ¡Vale!</a>
        </div>
    </div>
</div>

<div class="row skeleton">
    <div class="col-xs-12 col-sm-6">
        <!-- Swiper -->
        <div class="text-center hidden-sm hidden-md hidden-lg">
            <p class="zoom-info">Toca la imagen para ampliar.</p>
        </div>

        <div id="stage">
            <div class="close-icon pull-right"><i class="fa fa-2x fa-fw fa-times-circle-o"></i></div>
        </div>
        <div class="swiper-container">
            <div class="swiper-wrapper">
            </div>
            <!-- Add Pagination -->
        </div>
        <div class="swiper-pagination"></div>
    </div>
    <div class="non-readable text-center">
        <a class="btn-answer step2" value="non-readable" href="#">No consigo leer los ingredientes</a>
    </div>
    <div class="col-sm-6 hidden-xs">
        <div id="question-md"></div>
            <p class="step1 hidden-xs">En esta pantalla solo tienes que decirme si ves el símbolo “Sin gluten” en las imágenes que te voy a mostrar. Puede que haya varias imágenes. Se cargarán automáticamente después de cada respuesta.</p>
            <p class="step2 hidden-xs">Aquí necesito que leas la etiqueta y me digas si hay trigo o trazas en los ingredientes del prodcuto. Puede que haya vairas imágenes también.  No te preocupes, también se cargarán automáticamente después de cada respuesta.</p>
            <button type="button" class="btn btn-info btn-lg btn-answer step1" value="yes">Sí</button>
            <button type="button" class="btn btn-info btn-lg btn-answer step2" value="no">Yo no veo trigo</button>
            <button type="button" class="btn btn-info btn-lg btn-answer step1" value="no">No</button>
            <button type="button" class="btn btn-info btn-lg btn-answer step2" value="yes">Hay trigo o trazas</button>
        </div>

    </div>
</div>
<div class="row btn-group-answer-bottom hidden-sm hidden-md hidden-lg">
    <div class="col-xs-6 left">
        <button type="button" class="btn btn-white btn-answer step1" value="yes">Sí</button>
        <button type="button" class="btn btn-white btn-answer step2" value="no">Yo no veo trigo</button>
    </div>
    <div class="col-xs-6 right">
        <button type="button" class="btn btn-white btn-answer step1" value="no">No</button>
        <button type="button" class="btn btn-white btn-answer step2" value="yes">Hay trigo o trazas</button>
    </div>
</div>

<script type="text/javascript">
(function() {
// Default language
var userLocale = "en";
// Translations
var messages = {"en": {
                        "i18n_working_task": "Task",
                      },
                "es": {
                        "i18n_working_task": "Tarea",
                      },
               };
// Update userLocale with server side information
$(document).ready(function(){
    userLocale = document.getElementById('PYBOSSA_USER_LOCALE').textContent.trim();
});

function i18n_translate() {
    var ids = Object.keys(messages[userLocale])
    for (i=0; i<ids.length; i++) {
        console.log("Translating: " + ids[i]);
        document.getElementById(ids[i]).innerHTML = messages[userLocale][ids[i]];
    }
}

function setCookie(cname, cvalue, exdays) {
    var d = new Date();
    d.setTime(d.getTime() + (exdays*24*60*60*1000));
    var expires = "expires="+ d.toUTCString();
    document.cookie = cname + "=" + cvalue + "; " + expires;
}


function getCookie(cname) {
    var name = cname + "=";
    var ca = document.cookie.split(';');
    for(var i = 0; i <ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0)==' ') {
            c = c.substring(1);
        }
        if (c.indexOf(name) == 0) {
            return c.substring(name.length,c.length);
        }
    }
    return "";
}

function showHelp(step) {
    if (step === 'step1') {
        if (getCookie("glutenfreehelp1") != "") {
            $(".help-full.help1").hide();
        }
        else {
            $(".help-full.help1").show();
        }
    }
    else {
        if (getCookie("glutenfreehelp2") != "") {
            $(".help-full.help2").hide();
        }
        else {
            $(".help-full.help2").show();
        }
    }
}


$("#help1").off('click').on('click', function(){
        setCookie("glutenfreehelp1", 1, 30);
        $(".help-full.help1").hide();
        });

$("#help2").off('click').on('click', function(){
        setCookie("glutenfreehelp2", 1, 30);
        $(".help-full.help2").hide();
        });



pybossa.taskLoaded(function(task, deferred) {
    if ( !$.isEmptyObject(task) ) {
        // load image from flickr
        task.answer = { 'glutenfreeSeal': 'no',
                        'wheatIngredients': 'no',
                        'nimages': 0,
                        'readableIngredients': true}
        task.step = 'step1';
        if (task.info.images.length > 0) {
            var img = $('<img />');
            img.load(function() {
                // continue as soon as the image is loaded
                deferred.resolve(task);
            });
            img.attr('src', task.info.images[0]).css('height', 'auto');
            img.css('max-width', '100%');
            task.info.tmpImage = img;
            task.answer.nimages = task.info.images.length;
        }
        else {
            deferred.resolve(task);
        }
    }
    else {
        deferred.resolve(task);
    }
});


function saveAnswerAndClean(task, swiper, deferred) {
    $(".magnifik").magnifik('close');
    $(".step1").hide();
    $(".step2").hide();
    pybossa.saveTask(task.id, task.answer).done(function() {
        var deleteInstance = true;
        var cleanupStyles = false;
        swiper.destroy(deleteInstance, cleanupStyles);
        deferred.resolve();
    });

}

function updateQuestions() {
    var question1 = $("<h4/>");
    var question2 = $("<h4/>");
    question1.text('¿Ves el sello "Sin Gluten"?');
    question1.addClass('step1');
    question2.text('¿Trigo en los ingredientes?');
    question2.addClass('step2');

    var mq = window.matchMedia( "(min-width: 768px)" );
    if (mq.matches) {
        console.log(">=768");
        $("#question-md").html("");
        $("#question-md").append(question1);
        $("#question-md").append(question2);
    }
    else {
        console.log("<768");
        $("#question").html("");
        $("#question").append(question1);
        $("#question").append(question2);
    }

    $(".step1").show();

}

$(window).resize(function() {
    updateQuestions();
});

pybossa.presentTask(function(task, deferred) {
    if ( !$.isEmptyObject(task) ) {
        $(".swiper-wrapper").html("");
        //i18n_translate();

        updateQuestions();

        $("." + task.step).show();

        showHelp(task.step);

        var w = document.documentElement.clientWidth;
        var h = document.documentElement.clientHeight;

        $("#stage").css("height", "340px");

        $("body").bind('magnifik:open', function(){
                console.log("show");
                $("#stage").show();
                $(".swiper-container").hide();
                $(".swiper-pagination").hide();
                });

        $("body").bind('magnifik:close', function(){
                console.log("hide");
                $("#stage").hide();
                $(".swiper-container").show();
                $(".swiper-pagination").show();
                });


        $(".close-icon").bind('click', function(){
                $(".magnifik").magnifik('close');
                });



        for (i=0;i<task.info.images.length;i++) {
            var div = $("<div/>");
            div.addClass("swiper-slide");
            var img = $("<img/>");
            img.attr("src", task.info.images[i]);
            img.addClass("magnifik");
            div.append(img);
            $(".swiper-wrapper").append(div);
        }

        var swiper = new Swiper('.swiper-container', {
                pagination: '.swiper-pagination',
                paginationClickable: true
            });

        swiper.slideTo(0);
        swiper.update(true);

        $('.magnifik').magnifik({seekImage: false, stage: $("#stage")});

        $(".zoom-icon").off('click').on('click', function(){
                $(".magnifik").magnifik('open');
                });

        $('.btn-answer.step1').off('click').on('click', function(evt) {
            var $btn = $(this);
            var answer = $btn.attr("value");
            if (typeof answer != 'undefined') {
            
                task.answer.glutenfreeSeal = answer
                console.log("Step 1 completed");
                console.log(task.answer);
                if (answer === 'yes') {
                   saveAnswerAndClean(task, swiper, deferred);
                }
                else {
                    task.step = 'step2';
                    showHelp(task.step);
                    $(".step1").hide();
                    $(".step2").show();
                }
            }
            else {
                pybossaNotify('Unexpected type of answer.', true, 'error');
            }
        });

        $(".btn-answer").on("touchstart", function(){ 
            $(this).removeClass("mobileHoverFix");
        });
        $(".btn-answer").on("touchend", function(){ 
            $(this).addClass("mobileHoverFix");
        });


        $('.btn-answer.step2').off('click').on('click', function(evt) {
            var $btn = $(this);
            var answer = $btn.attr("value");
            if (typeof answer != 'undefined') {
                if (answer === 'non-readable') {
                    task.answer.readableIngredients = false;
                }
                else {
                    task.answer.wheatIngredients = answer;
                }
                console.log("Step 2 completed");
                console.log(task.answer);

                saveAnswerAndClean(task, swiper, deferred);
            }
            else {
                pybossaNotify('Unexpected type of answer.', true, 'error');
            }
        });
    }
    else {
        $(".skeleton").hide();
        pybossaNotify('You have contributed to all available tasks! Thanks!', true, 'info');
    }
});

pybossa.run('soytestproject1');
})();
</script>
